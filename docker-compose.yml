version: "3.8"

services:
  mariadb:
    image: mariadb:10.11
    container_name: my-comfyui-db
    restart: unless-stopped
    environment:
      # =========================
      # ❗【修改】数据库 root 密码
      # =========================
      MYSQL_ROOT_PASSWORD: change_me_root_pwd

      MYSQL_DATABASE: photos

      # =========================
      # ❗【修改】数据库用户
      # =========================
      MYSQL_USER: comfyui

      # =========================
      # ❗【修改】数据库普通用户密码
      # =========================
      MYSQL_PASSWORD: change_me_db_pwd

      TZ: Asia/Shanghai

    volumes:
      - db_data:/var/lib/mysql


  my-comfyui-server:
    image: unimrq/my-comfyui-server
    container_name: my-comfyui-server

    depends_on:
      - mariadb

    # =========================
    # ⚠️【修改】对外访问端口
    # =========================
    ports:
      - "58000:8000"

    volumes:
      # =========================
      # ❗【修改】图片 / 资源目录
      # =========================
      - ./Photos:/app/Photos

      # ⚠️【可选挂载】ComfyUI工作流目录
      - ./workflows:/app/workflows

      # ⚠️【可选挂载】提示词配置文件
      - ./prompts.json:/app/prompts.json

    environment:
      # =========================
      # ❗【修改】ComfyUI实际运行地址
      # =========================
      COMFYUI_SERVER: 127.0.0.1:8188

      ROOT_DIR: /app/Photos
      TEMP_DIR: /app/temp

      # =========================
      # ❗【修改】数据库连接信息
      # =========================
      DB_TYPE: mysql
      DB_USER: comfyui
      DB_PWD: change_me_db_pwd
      DB_NAME: photos
      DB_ADDRESS: mariadb:3306

      # =========================
      # ❗【修改】应用密钥
      # =========================
      APP_SECRET: change_me_app_secret

      TZ: Asia/Shanghai

    command: >
      bash -c "uvicorn main:app
      --host 0.0.0.0
      --port 8000
      --workers 1
      --loop uvloop
      --http httptools
      --proxy-headers
      --log-level info"

    restart: unless-stopped


volumes:
  db_data:
